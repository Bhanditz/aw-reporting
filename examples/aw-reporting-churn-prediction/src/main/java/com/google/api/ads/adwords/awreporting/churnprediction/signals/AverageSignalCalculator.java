package com.google.api.ads.adwords.awreporting.churnprediction.signals;

import com.google.api.ads.adwords.awreporting.churnprediction.annotations.AverageSignal;
import com.google.api.ads.adwords.awreporting.model.entities.ReportAccount;
import com.google.api.ads.adwords.awreporting.model.entities.ReportBase;
import com.google.api.ads.adwords.awreporting.model.util.DateUtil;

import org.apache.commons.beanutils.PropertyUtils;
import org.joda.time.DateTime;

import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;
import java.math.BigDecimal;
import java.util.List;

/**
 * TODO: Insert description here. (generated by gustavomoreira)
 */
public class AverageSignalCalculator implements SignalCalculator {
  private String propertyName;

  private int days;

  private int months;

  public AverageSignalCalculator(AverageSignal averageSignal) {
    this.propertyName = averageSignal.property();
    this.days = averageSignal.days();
    this.months = averageSignal.months();
  }

  @Override
  public Object calculateValueForAccount(List<ReportAccount> dataRows, Field field)
      throws IllegalAccessException, InvocationTargetException, NoSuchMethodException {
    Number accumulatedValue = null;
    DateTime firstDate = null;
    int rowsCount = 0;

    for (ReportBase report : dataRows) {
      DateTime dateTime = DateUtil.parseDateTime(report.getDay());
      if (firstDate == null) {
        firstDate = dateTime;
      }

      if (this.days > 0 && dateTime.plusDays(this.days - 1).isBefore(firstDate)) {
        break;
      } else if (this.months > 0 && dateTime.plusMonths(this.months - 1).isBefore(firstDate)) {
        break;
      }

      rowsCount++;

      Object propertyValue = PropertyUtils.getProperty(report, this.propertyName);
      Class propertyType = PropertyUtils.getPropertyType(report, this.propertyName);
      if (String.class.isAssignableFrom(propertyType)) {
        accumulatedValue =
            this.addAsBigDecimal(accumulatedValue, new BigDecimal((String) propertyValue));

      } else if (Long.class.isAssignableFrom(propertyType)) {
        accumulatedValue = this.addAsLong(accumulatedValue, (Long) propertyValue);
      }
    }
    if (rowsCount <= 0) {
      return SignalProcessor.INVALID_DOUBLE_SIGNAL;
    }
    return accumulatedValue.doubleValue() / rowsCount;
  }

  /**
   * @param accumulatedValue
   * @param propertyValue
   * @return
   */
  private Number addAsLong(Number accumulatedValue, Long propertyValue) {
    if (accumulatedValue == null) {
      return propertyValue;
    } else if (propertyValue == null) {
      return accumulatedValue;
    }
    return accumulatedValue.longValue() + propertyValue;
  }

  /**
   * @param accumulatedValue
   * @param propertyValue
   * @return
   */
  private Number addAsBigDecimal(Number accumulatedValue, BigDecimal propertyValue) {
    if (accumulatedValue == null) {
      return propertyValue;
    } else if (propertyValue == null) {
      return accumulatedValue;
    }
    return propertyValue.add((BigDecimal) accumulatedValue);
  }
}
